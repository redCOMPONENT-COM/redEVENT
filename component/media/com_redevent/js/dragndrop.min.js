(function(e){e.fn.dragndrop=function(t){function a(){if(e.inArray(m,["file","image","gallery"])<0)return!1;if(!g)return!1}function f(t,n){for(var r=0;r<t.length;r++)if(d(t[r])){var i=new FormData;i.append("dragFile",t[r]);var s=Date.now(),o=e("<div>").attr("id","div_media_single_"+s).addClass("reditemDragnDrop-single-element");e("#statusBar_"+g).after(o);var u=new l(e(o));u.setFileNameSize(t[r].name,t[r].size),c(i,u,o)}}function l(t){n++;var r="odd";n%2==0&&(r="even"),this.statusbar=e("<div class='statusbar "+r+" status_"+n+"'></div>"),this.filename=e("<div class='filename'></div>").appendTo(this.statusbar),this.size=e("<div class='filesize'></div>").appendTo(this.statusbar),this.progressBar=e("<div class='progressBar'><div></div></div>").appendTo(this.statusbar),this.abort=e("<div class='abort'>"+Joomla.JText._("COM_REDEVENT_UPLOAD_ABORT")+"</div>").appendTo(this.statusbar),t.append(this.statusbar),this.setFileNameSize=function(e,t){var n="",r=t/1024;if(parseInt(r)>1024){var i=r/1024;n=i.toFixed(2)+" MB"}else n=r.toFixed(2)+" KB";this.filename.html(e),this.size.html(n)},this.setProgress=function(e){var t=e*this.progressBar.width()/100;this.progressBar.find("div").animate({width:t},10).html(e+"% "),parseInt(e)>=100&&this.abort.hide()},this.setAbort=function(e){var t=this.statusbar;this.abort.click(function(){e.abort(),t.hide()})}}function c(e,n,r){var i=t.url,s={},o=jQuery.ajax({xhr:function(){var e=jQuery.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var t=0,r=e.loaded||e.position,i=e.total;e.lengthComputable&&(t=Math.ceil(r/i*100)),n.setProgress(t)},!1),e},url:i+"&uploadType="+m+"&uploadTarget="+g,type:"POST",contentType:!1,processData:!1,cache:!1,data:e,success:function(e){h(e,n,r)}});n.setAbort(o)}function h(n,r,o){r.setProgress(100),m=="file"&&e("#cform_dragndrop_upload"+b).val(n.trim());if(m=="gallery"){e("#cform_dragndrop_upload"+b).val(e("#cform_dragndrop_upload"+b).val()+","+n.trim()),r.deleteFile=e("<div class='deleteFile'><a class='dragndrop-delete-file'><img src='' alt='"+Joomla.JText._("COM_REDEVENT_UPLOAD_DELETE_FILE")+"'/></a></div>").appendTo(r.statusbar),Date.now||(Date.now=function(){return(new Date).getTime()}),r.preview=e("#gallery_preview_"+u);var u=Date.now(),a=e(o);s=e('input[name="jform[customfield_gallery_default]['+g+']"]').length,a.append('<div id="div_media_'+u+'" class="media"><div class="img-preview-container" style="position:relative;"><img id="gallery_preview_'+u+'" src="" class="img-polaroid" style="max-width: 100%; max-height: 100%;" /><label class="radio" for="reditemGallery-DefaultImage-Index-'+u+'"><input id="reditemGallery-DefaultImage-Index-'+u+'" class="reditem_gallery_default_image_index" type="radio" name="jform[customfield_gallery_default]['+g+']" value="'+s+'" /> '+Joomla.JText._("COM_REDEVENT_CUSTOMFIELD_GALLERY_SET_DEFAULT")+"</label></div></div>");var f=e("#gallery_preview_"+u);f.attr("src",M+n.trim()).load(function(){if(P){var t=e("#div_media_"+u);e("#div_media_"+u+" > .div-cropping-outer").length&&e("#div_media_"+u+" > .div-cropping-outer").remove(),t.append('<div class="div-cropping-outer"><a id="btnCrop_gallery_'+u+'" class="btn btnCrop">'+Joomla.JText._("COM_REDEVENT_FEATURE_CROP_BTN_LBL")+"</a></div>"),f.reditemCropImage({cropAreaId:"crop_area_"+u,cropWidth:j,cropHeight:F,cropBtn:"btnCrop_gallery_"+u,keepRatio:I})}}),v(),r.deleteFile.click(function(){e("#cform_dragndrop_upload"+b).val(e("#cform_dragndrop_upload"+b).val().replace(","+n.trim(),"")),r.statusbar.remove(),e("#div_media_"+u).parent().remove(),v()})}if(m=="image"){i!=null?(e("#"+i).find(".deleteFile").click(),e("#"+i).remove(),i=e(o).attr("id")):i=e(o).attr("id"),e("#cform_dragndrop_upload"+b).val(n.trim());if(t.hasOwnProperty("img_hidden_value")){var l=e("#"+t.img_hidden_value);l.val(n.trim())}r.deleteFile=e("<div class='deleteFile'><a class='dragndrop-delete-file'><img src='' alt='"+Joomla.JText._("COM_REDEVENT_UPLOAD_DELETE_FILE")+"'/></a></div>").appendTo(r.statusbar);var a=e("#"+O);e("#img_preview_"+g).length?e("#img_preview_"+g).css({"max-height":"100%","max-width":"100%"}):a.prepend('<div class="pull-left"><div class="img-preview-container" style="position:relative;"><img id="img_preview_'+g+'" src="" class="img-polaroid" style="max-width: 100%; max-height: 100%;" /></div></div>'),e("#img_preview_"+g).attr("src",M+n.trim()),e("#img_preview_"+g).load(function(){P&&(e("#"+a.attr("id")+" > .div-cropping-outer").length&&e("#"+a.attr("id")+" > .div-cropping-outer").remove(),a.append('<div class="div-cropping-outer"><a id="btnCrop_'+g+'" class="btn btnCrop">'+Joomla.JText._("COM_REDEVENT_FEATURE_CROP_BTN_LBL")+"</a></div>"),e(this).reditemCropImage({cropAreaId:"crop_area_"+g,cropWidth:j,cropHeight:F,cropBtn:"btnCrop_"+g,keepRatio:I}))}),r.deleteFile.click(function(){e("#cform_dragndrop_upload"+b).val(""),e(a).find(".div-cropping-outer").remove(),e(a).find(".img-preview-container").remove(),e("#img_preview_"+g).remove(),r.statusbar.remove();if(_!=""){var t=e("<div>");e(t).addClass("img-preview-container").css("position","relative"),e("<img>").attr("id","img_preview_"+g).attr("src",_).addClass("img-polaroid").css("max-width",H+"px").css("max-height",B+"px").css("margin-right","20px").appendTo(e(t)),e(t).appendTo(e(a))}})}}function p(e){function n(){return((1+Math.random())*65536|0).toString(16).substring(1)}var t=e||"-";return n()+n()+t+n()+t+n()+t+n()+t+n()+n()+n()}function d(t){if(t.type=="")return alert(Joomla.JText._("COM_REDEVENT_UPLOAD_FILE_INVALID")),!1;var n=t.type.split("/");return e.inArray(n[1],C)<0?(alert(Joomla.JText._("COM_REDEVENT_UPLOAD_FILE_INVALID")),!1):e.inArray(t.type,k)<0?(alert(Joomla.JText._("COM_REDEVENT_UPLOAD_FILE_INVALID")),!1):t.size==0?(alert(Joomla.JText._("COM_REDEVENT_UPLOAD_FILE_INVALID")),!1):L>0&&t.size>L?(alert(Joomla.JText._("COM_REDEVENT_UPLOAD_FILE_TOO_BIG")),!1):!0}function v(){if(e(r).parent().find(".reditemDragnDrop-single-element").length>0){var t=e(r).parent().find(".reditemDragnDrop-single-element").length;e(r).parent().find(".reditemDragnDrop-single-element").each(function(n){var r=t-n,i=e(this).find(".reditem_gallery_default_image_index");e(i).val(r)}),e(r).parent().find('.reditemDragnDrop-single-element input.reditem_gallery_default_image_index[type="radio"]:checked').length<=0&&e(r).parent().find('.reditemDragnDrop-single-element input.reditem_gallery_default_image_index[type="radio"]').first().prop("checked",!0)}}var n=0,r=e(this),i=null,s=0,o=function(){function t(t,n){n=n||document.createElement(e[t]||"div"),t="on"+t;var r=t in n;return r||(n.setAttribute||(n=document.createElement("div")),n.setAttribute&&n.removeAttribute&&(n.setAttribute(t,""),r=typeof n[t]=="function",typeof n[t]!="undefined"&&(n[t]=undefined),n.removeAttribute(t))),n=null,r}var e={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return t}(),u=function(){return!!window.FileReader};if(o("dragenter")&&o("dragover")&&o("drop")){var m=r.attr("upload-type"),g=r.attr("target"),y=r.attr("input-target");e("#"+y).prop("required")&&(e("#"+y).prop("required",!1),e("#"+g).prop("required",!0)),a();var b=p("_"),w=t.text,E=0;m=="image"&&(w=Joomla.JText._("COM_REDEVENT_DRAG_AN_IMAGE")),m=="gallery"&&(w=Joomla.JText._("COM_REDEVENT_DRAG_IMAGES")),u()||(w=Joomla.JText._("COM_REDEVENT_DRAG_FEATURE_NOT_SUPPORT"));var S=0;t.config.hasOwnProperty("includeBrowse")&&(S=parseInt(t.config.includeBrowse),isNaN(S)&&(S=0));var x=e("#cform_"+g+"_value").val();r.after('<div id="statusBar_'+g+'"></div>'),r.after('<div id="reditem_dragselect_'+b+'" class="dragselect">'+w+"</div>"),r.after('<input type="hidden" id="cform_dragndrop_upload'+b+'" name="jform[custom'+g+']" value="'+x+'" />'),S==1&&u()&&e("<span>").attr("href","javascript:void(0)").html(Joomla.JText._("COM_REDEVENT_DRAG_AND_DROP_BROWSE")).appendTo(e("#reditem_dragselect_"+b)).click(function(t){t.preventDefault(),e("#"+y).click()}),u()||e("<input>").attr("type","file").attr("name","dragFile").appendTo(e("#reditem_dragselect_"+b)).ajaxfileupload({action:t.url+"&uploadType="+m+"&uploadTarget="+g,params:{extra:"info"},onComplete:function(t){e("#"+y).attr("old-name")&&e("#"+y).attr("name",e("#"+y).attr("old-name")).removeAttr("old-name");var n=Date.now(),r=e("<div>").attr("id","div_media_single_"+n).addClass("reditemDragnDrop-single-element");e("#statusBar_"+g).after(r);var i=new l(e(r));h(t,i,r)},onStart:function(){e("#"+y).attr("old-name",e("#"+y).attr("name")).attr("name","dragFile")},onCancel:function(){e("#"+y).attr("old-name")&&e("#"+y).attr("name",e("#"+y).attr("old-name")).removeAttr("old-name")}});var T=e("#reditem_dragselect_"+b),N=null,C=t.config.ext.split(","),k=t.config.mime.split(","),L=-1;if(t.config.hasOwnProperty("size"))try{L=parseInt(t.config.size)}catch(A){L=-1}if(t.config.hasOwnProperty("keepOldProcessBar"))try{E=parseInt(t.config.keepOldProcessBar)}catch(A){E=0}var O="";if(t.hasOwnProperty("img_preview"))try{O=t.img_preview}catch(A){O=""}var M="";if(t.hasOwnProperty("img_preview_path"))try{M=t.img_preview_path}catch(A){M=""}var _="";if(t.hasOwnProperty("default_img"))try{_=t.default_img}catch(D){_=""}var P=!1,H="300",B="300",j="",F="",I=!1;return t.hasOwnProperty("cropConfig")&&t.cropConfig.hasOwnProperty("isEnable")&&(t.cropConfig.isEnable=="1"&&(P=!0),t.cropConfig.hasOwnProperty("previewWidth")&&(H=t.cropConfig.previewWidth),t.cropConfig.hasOwnProperty("previewHeight")&&(B=t.cropConfig.previewHeight),t.cropConfig.hasOwnProperty("cropWidth")&&(j=t.cropConfig.cropWidth),t.cropConfig.hasOwnProperty("cropHeight")&&(F=t.cropConfig.cropHeight),t.cropConfig.hasOwnProperty("keepRatio")&&(I=t.cropConfig.keepRatio)),T.on("dragenter",function(e){e.stopPropagation(),e.preventDefault()}),T.on("dragover",function(e){e.stopPropagation(),e.preventDefault()}),T.on("drop",function(t){t.preventDefault();if(t.type==="drop"&&u()){a(),N=t.dataTransfer?t.dataTransfer.files:t.originalEvent.dataTransfer.files,!E&&m!="gallery"&&e("#statusBar_"+g).empty();if((m=="file"||m=="image")&&N.length>1){alert(Joomla.JText._("COM_REDEVENT_UPLOAD_1_FILE_ONLY"));return}f(N,T)}}),e(document).on("dragenter",function(e){e.stopPropagation(),e.preventDefault()}),e(document).on("dragover",function(e){e.stopPropagation(),e.preventDefault(),T.css("border","2px dotted #0B85A1")}),e(document).on("drop",function(e){e.stopPropagation(),e.preventDefault()}),this.addInputTarget=function(t){u()&&e("#"+t).on("change",function(t){t.preventDefault(),a(),N=t.originalEvent.target.files,!E&&m!="gallery"&&e("#statusBar_"+g).empty();if((m=="file"||m=="image")&&N.length>1){alert(Joomla.JText._("COM_REDEVENT_UPLOAD_1_FILE_ONLY"));return}f(N,T)})},y!=null&&u()&&this.addInputTarget(y),this}}})(jQuery);